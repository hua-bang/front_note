# 22 | 哈希算法（下）：哈希算法在分布式系统中有哪些应用?

![img](https://static001.geekbang.org/resource/image/42/7c/424e79d4fa84624b5fff2845b8c6317c.jpg)

还有三种应用：**负载均衡、数据分片、分布式存储。**

### 负载均衡

我们知道，负载均衡算法有很多，比如轮询、随机、加权轮询等。那如何才能实现一个会话粘滞（session sticky）的负载均衡算法呢？也就是说，我们需要在同一个客户端上，在一次会话中的所有请求都路由到同一个服务器上。

最直接的方法就是，维护一张映射关系表，这张表的内容是客户端 IP 地址或者会话 ID 与服务器编号的映射关系。（IP hash）客户端发出的每次请求，都要先在映射表中查找应该路由到的服务器编号，然后再请求编号对应的服务器。

- 弊端：
  - 如果客户端很多，映射表可能会很大，比较浪费内存空间；
  - 客户端下线、上线，服务器扩容、缩容都会导致映射失效，这样维护映射表的成本就会很大；

可以通过哈希算法，对客户端IP地址或者会话ID计算哈希值，将取得的哈希值于服务器列表的大小进行取模运算，最终得到的值就是应该被路由到的服务器编号。

### 数据分片

1. 如何统计“搜索关键词”出现的次数？
   - 我们可以先对数据进行分片，然后采用多台机器处理的方法，来提高处理速度
   - 思路：为了提高处理的速度，我们用 n 台机器并行处理。我们从搜索记录的日志文件中，依次读出每个搜索关键词，并且通过哈希函数计算哈希值，然后再跟 n 取模，最终得到的值，就是应该被分配到的机器编号。
2. 如何快速判断图片是否在图库中
   - 当我们要判断一个图片是否在图库中的时候，我们通过同样的哈希算法，计算这个图片的唯一标识，然后与机器个数 n 求余取模。假设得到的值是 k，那就去编号 k 的机器构建的散列表中查找。

### 分布式存储

1. #### 背景

   - 数据要合理分布在多台机器上
   - 可以通过哈希算法取得哈希值，再取模，得到缓存的机器编号。
   - 数据增多时，我们如何扩容？直接加上机器？NO，会使得之前的缓存失效。

2. #### 如何解决

   - **一致性哈希算法**就要登场了
     - 假设我们有 k 个机器，数据的哈希值的范围是[0, MAX]。我们将整个范围划分成 m 个小区间（m 远大于 k），每个机器负责 m/k 个小区间。当有新机器加入的时候，我们就将某几个小区间的数据，从原来的机器中搬移到新的机器中。

