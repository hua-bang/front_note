### TCP三次握手和四次挥手

- #### tcp是什么

  - TCP传输控制协议是一种面向连接的，可靠的，基于字节流的传输层通信协议。

- #### 计算机网络的七层

  - 图示

    ![img](https://camo.githubusercontent.com/282653dfd626be76e83c98b71cd8bc64e7fe876d47ca1b919f17fe3a1768b9f8/687474703a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323434383735322d313235396366326233646635333766342e6a70673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

  - 分层

    - 应用层
    - 表示层
    - 会话层
    - 传输层
    - 网络层
    - 数据链路层
    - 物理层

  - 注意：

    - tcp在传输层，http在应用层，ip在网络层

    - 数据从应用层下发，会在每一层都加上头部信息，进行封装，然后发到数据接收端，数据接收端不断解封装

      - | OSI中的层  |                  功能                  |            TCP/IP协议族            |
        | :--------: | :------------------------------------: | :--------------------------------: |
        |   应用层   | 文件传输，电子邮件，文件服务，虚拟终端 | TFTP,HTTP,SNMP,FTP,SMTP,DNS,Telnet |
        |   表示层   |     数据格式化，代码转换，数据加密     |              没有协议              |
        |   会话层   |       解除或建立与别的接点的联系       |              没有协议              |
        |   传输层   |            提供端对端的接口            |              TCP,UDP               |
        |   网络层   |            为数据包选择路由            |   IP，ICMP，RIP，OSRF，BGP，IGMP   |
        | 数据链路层 |     传输有地址的帧以及错误检测功能     |  SLIP，CSLIP，PPP，ARP，RARP，MTU  |
        |   物理层   |  以二进制数据形式在物理媒体上传输数据  |     ISO2110，IEEE802 IEEE802.2     |

  - tcp图示

    ![img](https://camo.githubusercontent.com/1d1e6bea252213501999a737d596fb21e5fd1f14ff8db7497baed37395fee66d/687474703a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323434383735322d613636353239636164633332343032302e6a70673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

    - 头部结构：

      - 源端口，目标端口
        - 用于区分主机中的不同进程，类比ip确定不同的主机，源端口号和目标端口号配合ip的源地址和目标地址确定唯一的tcp链接。
      - 序号：
        - 用来标识从tcp发送端到tcp接收端发送的数据字节流。这个报文段中的的第一个数据字节在数据流中的序号；主要用来解决网络报乱序的问题。
        - 解决乱序
      - 确认号
        - 32位确认序列号包含发送确认的一端所期望收到的下一个序号，因此，确认序号应当是上次已成功收到数据字节序号加1。不过，只有当标志位中的ACK标志（下面介绍）为1时该确认序列号的字段才有效。主要用来解决不丢包的问题；
        - 解决丢包的问题
      - Offset:给出首部中32 bit字的数目，需要这个值是因为任选字段的长度是可变的。这个字段占4bit（最多能表示15个32bit的的字，即4*15=60个字节的首部长度），因此TCP最多有60字节的首部。然而，没有任选字段，正常的长度是20字节；
      - TCP flags:TCP首部中有6个标志比特，它们中的多个可同时被设置为1，主要是用于操控TCP的状态机的，依次为URG，ACK，PSH，RST，SYN，FIN。每个标志位的意思如下：
        - URG：此标志表示TCP包的紧急指针域（后面马上就要说到）有效，用来保证TCP连接不被中断，并且督促中间层设备要尽快处理这些数据；
        - ACK表示应答域有效，就是说签名所说的TCP应答号将会包含在TCP数据包中，1为有效
        - PSH：push操作，所谓Push操作就是指在数据包到达接收端以后，立即传送给应用程序，而不是在缓冲区中排队；
        - RST：这个标志表示连接复位请求。用来复位那些产生错误的连接，也被用来拒绝错误和非法的数据包；
        - SYN：表示同步序号，用来建立连接。
          - SYN和ACK搭配使用
            - 连接请求时，SYN = 1 ACK=0（第一次握手）
            - 连接响应，SYN=1，ACK=1（第二次握手）
        - FIN：表示发送端已经达到数据末尾了，数据传输完成，没有数据可以传送了，发送FIN标志位的TCP数据包后，连接将被断开。
        - Window:窗口大小，也就是有名的滑动窗口，用来进行流量控制；

    - 重点：

      - ACK：TCP协议规定，只有ACK=1时有效，也规定连接建立后所有发送的报文的ACK必须为1
      - SYN: 在连接建立时用于同步序号SYN=1，ACK=0表示时来连接请求，同意，对方则响应SYN=1和ACK=1
      - FIN （finis）即完，终结的意思， 用来释放一个连接。当 FIN = 1 时，表明此报文段的发送方的数据已经发送完毕，并要求释放连接
      - 序号
        - tcp传输中每一个字节都按顺序编号
        - 序号使用mod 2的32次方

    - #### 三次握手

      ![image-20210403114956297](F:\github\js_note\network\TCP\image-20210403114956297.png)

      流程：

      1. 第一次握手：建立连接，客户端发送连接请求报文段，SYN置为1，SequenceNumeber为x，客户端等待服务器确认
      2. 第二次握手，服务器收到SYN报文段，设置ACkNumber为x+1，同时自己要发送SYN的请求信息，SYN置为1，SequenceNumeber为Y，将上述放到一个报文段（SYN+ACK），一并发送客户端，服务器金人SYN_RECV
      3. 第三次握手：SYN+ACK报文段，然后将ACKNUmbver置为y+1,向服务器发送ACK报文段，这个报文段发送完毕以后，客户端和服务器端都进入ESTABLISHED状态，完成TCP三次握手。

      为什么要第三次握手：防止服务器端一直等待而浪费资源

    - 四次挥手

      - 用于tcp连接的断开

      - 图示：

        ![image-20210403130725390](F:\github\js_note\network\TCP\image-20210403130725390.png)

      - 流程

        - 第一次挥手：主机1，设置Seq和Ack,向主机2发送一个fin报文，表示主机1没有数据在发送主机2。
        - 第二次挥手：主机2收到主机1返送的FIn报文，向主机1回一个ACK报文，即“统一关闭请求”
        - 第三次挥手：主机2向主机1返送FIn报文段，请求关闭连接
        - 第四次挥手：主机1收到主机2发送的FIN报文段，向主机2发送ACK报文段，然后主机1进入TIME_WAIT状态；主机2收到主机1的ACK报文段以后，就关闭连接；此时，主机1等待2MSL后依然没有收到回复，则证明Server端已正常关闭，那好，主机1也可以关闭连接了。