### 游览器的回流和重绘

#### 前言：

1. 游览器使用流式布局模型(Flow Based Layout)
2. 游览器将HTML解析成DOM，将CSS解析成CSSOM，DOM和CSSOM合并产生了Render Tree。
3. 有了Render Tree，我们就可以知道所有节点的样式，然后计算他们在页面的大小和位置，最后把节点绘制到页面上。
4. 对于流式布局，对Render Tree的计算只需要遍历一边就行，但table及内部的元素除外，他们可能要重新计算，通常要花3被于同等元素的时间，避免使用table布局。

**一句话：回流必将一起重绘，重绘不一定引起回流**

#### 回流（Reflow）

当Render tree中部分或全部元素的尺寸，结构，或某些属性发生改变时，游览器重新渲染部分或全部的文档的过程叫回流。

会导致回流的操作：

- 页面首次渲染
- 游览器窗口大小改变
- 元素尺寸或位置发生改变
- 元素内容变化
- 元素字体大小变化
- 添加或者删除可见的DOM元素
- 激活CSS伪类（例如：hover）
- 查询某些属性或调用某些方法

#### 重绘（Repaint）

当页面的元素样式的改变并不影响他在文档流中的位置时（例如：color,bgcolor,visibility）等，游览器会将新样式赋予给元素并且重新绘制它，过程叫重绘。

#### 性能影响

回流比重绘的代价还要高

有时即使仅仅回流一个单一的元素，它的父元素以及任何跟随它的元素也会产生回流。

游览器上的优化：

游览器会维护一个队列，把所有引起回流和重绘的操作放入队列中，如果队列中的任务数量或者时间间隔到一个阈值的时候，队列会清空，进行一次批处理，把多次回流和重绘变成一次。

因为队列中可能会有影响到这些属性或方法返回值的操作，即使你希望获取的信息与队列中操作引发的改变无关，浏览器也会强行清空队列，确保你拿到的值是最精确的。

#### 如何避免

- **CSS**
  - 避免table布局
  - DOM树的最末端改变class
  - 避免设置多层内联
  - 将动画效果应用到`position`属性为`absolute`或`fixed`的元素上。
  - 避免使用css表达式
- **JS**
  - 避免频繁操作样式，最好一次性重写`style`属性，或者将样式列表定义为`class`并一次性更改`class`属性。
  - 避免频繁操作DOM。
  - 可以先为元素设置display：none，结束后再显示，display：none的元素进行dom操作不会引发回流和重绘
  - 避免读取引发回流、重绘的属性。
  - 对具有复杂动画的元素使用绝对定位，使它脱离文档流，否则会引起父元素及后续元素频繁回流